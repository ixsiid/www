<!---
 Title: F0推定VSTプラグイン"Trail"をリリースしました。
 Tags: VSTプラグイン, ソフトウェア, 音声処理
 Date: 2020-09-28
-->

# Trail

入力音声（モノラル限定）から、基音となるF0を推定し、パラメータとして出力します。
出力されたパラメータはサイドチェインやトリガー起動用に使うことができます。

出力される信号はバイパスするのでディレイ0ですが、F0推定値の出力はFFT変換をするためサンプリング数に応じたディレイが生じます。

詳しい使い方は[リポジトリ](https://github.com/ixsiid/Trail)のReadmeを読んでください。

# なぜ作ったか

いわゆるバ美肉Vtuberである[魔王マグロナ](https://twitter.com/ukyo_rst)さんのボイチェン活用がすごくてボイチェン自体に興味持ちました。

マグロナさんが配信でボイチェン手法を解説されていましたが、その中で[Blue Cat's FreqAnalyst Pro](https://www.bluecataudio.com/Products/Product_FreqAnalystPro/)という
アナライザーのスペクトルをMIDI CC信号として出力する機能を利用していました。

これを実際につかってみると、周波数全域をMIDI CC 7bitに割り当てているようで、実際の声に相当する帯域だと7～10段程度の分解能しかありませんでした。
また、MIDI CCとして出力できるパラメータは、スペクトル密度を設定されたしきい値を超える分布のうち、最低周波数・最大周波数・スペクトルパワーの平均周波数の3種類になります。
これが、声の高さに比例するようにパラメータを調整するのが難しく、いっそ自分でF0推定をするプラグインを作ろうと思ったのがきっかけです。


# F0推定

もともと自分に合わせたパラメータ調整が大変だったというのが開発のきっかけなので、なるべく少ないパラメータで精度の高い推定が得られることが目標でした。

## うまくいかなかったこと
- スペクトル密度の最大値検出 -> 普通にF1, F2のほうがピークが高いこともあり、規則性が人や発声のしかたに影響するため、そこから更にF0に限定する手法が導けなかった
- ピーク・ディップスコア計算 -> DIOを参考にしたが計算量が多くなりそうだったので、実装途中であきらめ（サンプリング44100Hzでバッファ512の場合、11msecの間に計算を終わらせる必要があるし、当然CPU使用率も数％におさめないといけない）
- 移動平均による雑音成分の除去 -> 環境によるが、特定周波数の雑音が推定の邪魔をする。（自分の環境ではファンノイズ）ここをがんばるより、前段のプラグインで専門の雑音除去をいれたほうが効果が大きい

## 最終的にやったこと

包絡折線を描いて、折れ点の打ち最も低い周波数をF0と扱う。
設定するパラメータは、「無音時のノイズレベル」一つだけ。

![Fピーク包絡線](/article/trail/f0.png)

処理の流れ
1. 左点として、F=0Hz, P=ノイズレベルとする
1. 右点として、F=Fmax, P=ノイズレベルとする
1. 左点と右点を線で繋ぎ、スペクトルの線からの距離を計算する
1. 距離が最大になるものを新たな右点として、計算を繰り返す。

細かい理論はおいといて、しきい値を自動調整しながら最大値によるピーク検出を繰り返してます。
包絡折線を使うことで、それがヴィジュアル的にもわかりやすくパラメータとして調整がしやすくなったと思います。

# おまけ

前記のマグロナさんの解説に、MIDI CC信号を射影変換するmidiCurveというプラグインが紹介されていました。
が、これも個人開発のプラグインのようで、サポートや出所があやしかっため、開発したプラグインTrailに同じ機能を盛り込んでいます。

マグロナさんが全ての環境を公開しているわけではないですが、下記の内容でおおよそ再現できると思います。

- RX7 Elements De-noise
- **Trail**
- Graillon 2 (Sidechain by Trail Fp)
- (EQなど追加する場合)




# これから

利用がそもそもニッチなので、使ってみた感想を聞いてみたいです。

自分でつかった感じ、これができたからといって自由なボイチェンができるわけではないので、少しでも理想の声に近づけるサポートができるプラグインにしたいです。
