<!---
 Title: Dyamic Boneは何をしているか
 Tags: Unity
 Date: 2020-07-22
-->

# Dynamic Boneは何をしているか

初期化処理はおいといて、"揺れる"パラメータと物理演算の関係について主に解説します。


# LateUpdateでの処理内容

LateUpdateメソッド内にて指定したボーンツリーの物理演算を行っている。

## 範囲外による物理演算無効のチェック

*Distant Disable*がtrueの場合、最初に基準Transform（*Reference Object*、指定なしの場合はカメラ）から対象Root Transformの距離をチェックしている。
この対象が*Distance To Object*以上離れている場合、Dynamic Boneで指定されたツリーはすべて初期の位置に戻され、そのフレーム内での物理演算が無効化される。

## UpdateParticle1
力場の計算

*Gravity* -> ルートTransformの回転に合わせて量を可変させている。初期値から回転していないときは力場は0になる

*Force* -> シーンの座標系に対する力場の大きさ

普通に重力をイメージしたときは、*Force*を使うのがいい

### ダンピング・イナーシャ・摩擦の計算
それぞれ *Damping*, *Inert*, *Friction*
InertはDynamic Boneが関連付けられたオブジェクト(≠Root)の移動量に対してどれだけ追従させるかに影響する。
*Damping*は、各Particle（頂点）の移動量に対して減衰度合を定めている。
*Friction*は、接触判定が成されたとき、*Damping*に追加される。*Damping + Friction*が1を超えるとき、接触したときに横滑りを起こさない。（接触の反発は受けるため、それが横滑りのような挙動になることはある）

最終的な移動量は、Damping影響部、力場、イナーシャ影響部の合計である。（≠積）

※稀に*Inert*を1にすると、完全に固定されると勘違いしている人がいるが、
　これは、「平行移動に対して感度が0」になった状態の間違いである。
　回転させたり、接触判定を与えれば完全固定されているわけではないのがわかる

また、これらの結果による移動先が一時的に保存され、LateUpdateの最後で一斉に各Particleに適用される

## UpdateParticle2

### Elasticityの影響

ダンピング・イナーシャ・摩擦の影響により定まった移動量に対して、どれだけ追従させないかの影響度合い。
Elasticityが1の時、一つ親から見た位置に常に固定されているため、あたかも剛体のようにふるまう

日本語の印象としては「剛性」に近い

### Stiffnessの影響

1フレームないでの一つ親からみた移動量に対して制限をかけるパラメータ
例えばStiffnessが0.5の時、親から対象Particleまでの距離と同量の移動量に制限する
※0.1 なら x1.8, 0.2ならx1.6, 0.8ならx0.4, 0.9ならx0.2, 1なら0

### 接触判定

互いの中心から、互いの半径を合計した値の距離になるまで強制的に移動させる

### Freeze

該当軸の移動量を0にする。接触判定の後にあるため、この処理の結果当たり判定の内側にめり込むことがある

### keep length



各Particleは親から順に処理される


